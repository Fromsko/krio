name: Release

on:
  push:
    branches:
      - main
    paths:
      - '.version'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          VERSION=$(cat .version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true

      - name: Build for multiple platforms
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p dist

          # Build for Linux
          GOOS=linux GOARCH=amd64 go build -ldflags="-X 'github.com/fromsko/krio/app.Version=$VERSION'" -o dist/krio-linux-amd64 .
          GOOS=linux GOARCH=arm64 go build -ldflags="-X 'github.com/fromsko/krio/app.Version=$VERSION'" -o dist/krio-linux-arm64 .

          # Build for macOS
          GOOS=darwin GOARCH=amd64 go build -ldflags="-X 'github.com/fromsko/krio/app.Version=$VERSION'" -o dist/krio-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -ldflags="-X 'github.com/fromsko/krio/app.Version=$VERSION'" -o dist/krio-darwin-arm64 .

          # Build for Windows
          GOOS=windows GOARCH=amd64 go build -ldflags="-X 'github.com/fromsko/krio/app.Version=$VERSION'" -o dist/krio-windows-amd64.exe .

      - name: Create archives
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd dist

          # Create tar.gz for Unix-like systems
          tar -czf krio-${VERSION}-linux-amd64.tar.gz krio-linux-amd64
          tar -czf krio-${VERSION}-linux-arm64.tar.gz krio-linux-arm64
          tar -czf krio-${VERSION}-darwin-amd64.tar.gz krio-darwin-amd64
          tar -czf krio-${VERSION}-darwin-arm64.tar.gz krio-darwin-arm64

          # Create zip for Windows
          zip krio-${VERSION}-windows-amd64.zip krio-windows-amd64.exe

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > release-notes.md << 'EOF'
          ## Krio $VERSION

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š

          - **Linux AMD64**: `krio-*-linux-amd64.tar.gz`
          - **Linux ARM64**: `krio-*-linux-arm64.tar.gz`
          - **macOS Intel**: `krio-*-darwin-amd64.tar.gz`
          - **macOS Apple Silicon**: `krio-*-darwin-arm64.tar.gz`
          - **Windows**: `krio-*-windows-amd64.zip`

          ### ğŸš€ å¿«é€Ÿå¼€å§‹

          1. ä¸‹è½½å¹¶è§£å‹å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. å¤åˆ¶ `config.example.yaml` ä¸º `config.yaml`
          3. ç¼–è¾‘ `config.yaml` å¡«å…¥ä½ çš„ API Key å’Œé…ç½®
          4. è¿è¡Œ: `./krio init` åˆå§‹åŒ–é…ç½®
          5. è¿è¡Œ: `./krio run -u <URL>` å¼€å§‹ä½¿ç”¨

          ### ğŸ“š æ–‡æ¡£

          å®Œæ•´ä½¿ç”¨æ–‡æ¡£è¯·å‚è€ƒ: [README.md](https://github.com/fromsko/krio/blob/main/README.md)

          ### âœ¨ ä¸»è¦åŠŸèƒ½

          - ğŸ¤– AI é©±åŠ¨çš„æ™ºèƒ½ç½‘é¡µå†…å®¹æå–å’Œæ€»ç»“
          - ğŸ“ è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–çš„ Markdown ç¬”è®°
          - ğŸ”— æ”¯æŒ Obsidian MCP ç›´æ¥ä¿å­˜
          - ğŸ“ æ”¯æŒä» .txt å’Œ .md æ–‡ä»¶æ‰¹é‡å¯¼å…¥ URL
          - âš¡ å¹¶å‘æŠ“å–å’Œæ™ºèƒ½ç¼“å­˜
          - ğŸ¯ å®Œæ•´çš„ CLI å·¥å…· (init, run, cache, config, version)

          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            dist/krio-*.tar.gz
            dist/krio-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
